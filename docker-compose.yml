services:
    # Redis Service
    redis:
        image: redis:7-alpine
        container_name: vrecom_redis
        ports:
            - "${REDIS_PORT:-6379}:6379"
        volumes:
            - redis_data:/data
        networks:
            - vrecom_network
        restart: unless-stopped
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 512M
                reservations:
                    cpus: "0.1"
                    memory: 128M
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 5s

    # Zookeeper Service
    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: vrecom_zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
            KAFKA_HEAP_OPTS: "-Xms128m -Xmx256m"
        volumes:
            - zookeeper_data:/var/lib/zookeeper/data
            - zookeeper_logs:/var/lib/zookeeper/log
        networks:
            - vrecom_network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 512M
                reservations:
                    cpus: "0.1"
                    memory: 128M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "curl -s http://localhost:8080/commands/ruok || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 15s

    # Kafka Service
    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: vrecom_kafka
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            - "${KAFKA_PORT:-9092}:9092"
            - "9093:9093"
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:9093
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
            KAFKA_LOG_RETENTION_HOURS: 168
            KAFKA_LOG_SEGMENT_BYTES: 1073741824
            KAFKA_HEAP_OPTS: "-Xms256m -Xmx512m"
        volumes:
            - kafka_data:/var/lib/kafka/data
        networks:
            - vrecom_network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: 1G
                reservations:
                    cpus: "0.25"
                    memory: 256M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1",
                ]
            interval: 30s
            timeout: 15s
            retries: 5
            start_period: 30s

    # Kafka UI (Optional - for monitoring)
    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: vrecom_kafka_ui
        depends_on:
            kafka:
                condition: service_healthy
        ports:
            - "${KAFKA_UI_PORT:-8080}:8080"
        environment:
            KAFKA_CLUSTERS_0_NAME: vrecom-cluster
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9093
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
            JAVA_OPTS: "-Xms128m -Xmx256m"
        networks:
            - vrecom_network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 512M
                reservations:
                    cpus: "0.1"
                    memory: 128M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --no-verbose --tries=1 --spider http://localhost:8080 || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 15s

    # API Server (Go)
    api_server:
        build:
            context: ./backend/api_server
            dockerfile: Dockerfile
            # Enable BuildKit for better caching
        container_name: vrecom_api_server
        ports:
            - "${API_SERVER_PORT:-2030}:${API_SERVER_PORT:-2030}"
        environment:
            - STATUS_DEV=${STATUS_DEV:-dev}
            - HOST_ADDRESS=${API_SERVER_HOST:-0.0.0.0}
            - HOST_PORT=${API_SERVER_PORT:-2030}
            - HOST_READ_TIMEOUT=${API_SERVER_READ_TIMEOUT:-60}
            - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-in-production}
            - SESSION_SECRET=${SESSION_SECRET:-your-super-secret-session-key-change-in-production}
            - REDIS_HOST=${REDIS_HOST:-redis}
            - REDIS_PORT=${REDIS_PORT:-6379}
            - REDIS_PASSWORD=${REDIS_PASSWORD:-}
            - REDIS_DB=${REDIS_DB:-0}
            - AI_SERVER_URL=${AI_SERVER_URL:-http://ai_server:9999}
            - HOST_IP=${HOST_IP:-localhost}
            - FRONTEND_URL=${FRONTEND_URL:-http://${HOST_IP:-localhost}:5173}
            - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
            - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
            - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL:-http://${HOST_IP:-localhost}:2030/api/v1/auth/google/callback}
            # Go runtime optimizations
            - GOGC=100
            - GOMEMLIMIT=450MiB
        volumes:
            - ./backend/api_server/logs:/app/logs
            - ./backend/api_server/config:/app/config
            - ./data/user_logs:/app/user_logs
        networks:
            - vrecom_network
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "1.0"
                    memory: 512M
                reservations:
                    cpus: "0.25"
                    memory: 128M
        healthcheck:
            test:
                [
                    "CMD",
                    "curl",
                    "-f",
                    "http://localhost:${API_SERVER_PORT:-2030}/api/v1/ping",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

    # AI Server (Python)
    ai_server:
        build:
            context: ./backend/ai_server
            dockerfile: Dockerfile
        container_name: vrecom_ai_server
        ports:
            - "${AI_SERVER_PORT:-9999}:${AI_SERVER_PORT:-9999}"
        environment:
            - HOST=${AI_SERVER_HOST:-0.0.0.0}
            - PORT=${AI_SERVER_PORT:-9999}
            - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-in-production}
            - SESSION_SECRET=${SESSION_SECRET:-your-super-secret-session-key-change-in-production}
            - MYSQL_HOST=${MYSQL_HOST:-mysql}
            - MYSQL_PORT=${MYSQL_PORT:-3306}
            - MYSQL_USER=${MYSQL_USER:-admin}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD:-pokiwar0981}
            - MYSQL_DATABASE=${MYSQL_DATABASE:-shop}
            - MONGODB_HOST=${MONGODB_HOST:-mongodb}
            - MONGODB_PORT=${MONGODB_PORT:-27017}
            - MONGODB_USERNAME=${MONGODB_USERNAME:-root}
            - MONGODB_PASSWORD=${MONGODB_PASSWORD:-password}
            - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9093}
            - KAFKA_GROUP_ID=${KAFKA_GROUP_ID:-vrecom_ai_server_group}
            # Python optimizations
            - PYTHONUNBUFFERED=1
            - PYTHONDONTWRITEBYTECODE=1
            - MALLOC_TRIM_THRESHOLD_=100000
        volumes:
            - ./backend/ai_server/src:/app/src
            - ./backend/ai_server/config:/app/config
            - ./backend/ai_server/tasks:/app/tasks
            - ./backend/ai_server/logs:/app/logs
            - ./backend/ai_server/models:/app/models
            - ./data/uploads:/app/data/uploads
        networks:
            - vrecom_network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "2.0"
                    memory: 2G
                reservations:
                    cpus: "0.5"
                    memory: 512M
        healthcheck:
            test:
                [
                    "CMD",
                    "curl",
                    "-f",
                    "http://localhost:${AI_SERVER_PORT:-9999}/api/v1/health",
                ]
            interval: 30s
            timeout: 15s
            retries: 5
            start_period: 30s

    # Prometheus (Monitoring for AI Server)
    prometheus:
        image: prom/prometheus:latest
        container_name: vrecom_prometheus
        ports:
            - "${PROMETHEUS_PORT:-9090}:9090"
        volumes:
            - ./backend/ai_server/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=7d"
            - "--storage.tsdb.retention.size=1GB"
        networks:
            - vrecom_network
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 512M
                reservations:
                    cpus: "0.1"
                    memory: 128M
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:9090/-/healthy",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

    # Frontend (React + Vite)
    frontend:
        build:
            context: ./frontend/project
            dockerfile: Dockerfile
            args:
                - VITE_API_SERVER_URL=${VITE_API_SERVER_URL:-http://localhost:2030}
                - VITE_AI_SERVER_URL=${VITE_AI_SERVER_URL:-http://localhost:9999}
        container_name: vrecom_frontend
        ports:
            - "${FRONTEND_PORT:-5173}:${FRONTEND_PORT:-5173}"
        environment:
            - VITE_API_SERVER_URL=${VITE_API_SERVER_URL:-http://localhost:2030}
            - VITE_AI_SERVER_URL=${VITE_AI_SERVER_URL:-http://localhost:9999}
            - FRONTEND_PORT=${FRONTEND_PORT:-5173}
        volumes:
            - ./frontend/project/src:/app/src
            - ./frontend/project/public:/app/public
        networks:
            - vrecom_network
        depends_on:
            api_server:
                condition: service_healthy
            ai_server:
                condition: service_healthy
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 256M
                reservations:
                    cpus: "0.1"
                    memory: 64M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --no-verbose --tries=1 --spider http://localhost:${FRONTEND_PORT:-5173} || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

networks:
    vrecom_network:
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1500

volumes:
    redis_data:
    prometheus_data:
    zookeeper_data:
    zookeeper_logs:
    kafka_data:
