<mxfile host="app.diagrams.net">
  <diagram id="user-auth-flow" name="User Authentication Flow">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Tiêu đề -->
        <mxCell id="title" value="Sơ Đồ Luồng Xác Thực Người Dùng&#xa;(User Authentication Flow)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="264" y="20" width="300" height="40" as="geometry" />
        </mxCell>

        <!-- Start -->
        <mxCell id="start" value="Bắt đầu" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="364" y="80" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Người dùng nhấn đăng nhập -->
        <mxCell id="user-click-login" value="Người dùng nhấn nút&#xa;&quot;Đăng nhập với Google&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="170" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Frontend gọi API /auth/google -->
        <mxCell id="call-begin-auth" value="Frontend gọi API&#xa;GET /auth/google" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="260" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- BeginAuthHandler xử lý -->
        <mxCell id="begin-auth-handler" value="BeginAuthHandler&#xa;tạo Auth URL và Session" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="350" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Redirect đến Google -->
        <mxCell id="redirect-google" value="Redirect người dùng&#xa;đến Google OAuth" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="440" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Người dùng xác thực với Google -->
        <mxCell id="user-auth-google" value="Người dùng đăng nhập&#xa;và cho phép truy cập&#xa;trên Google" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="530" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Google callback -->
        <mxCell id="google-callback" value="Google redirect về&#xa;/auth/callback với code" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="630" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- CallbackHandler xử lý -->
        <mxCell id="callback-handler" value="CallbackHandler&#xa;đổi code lấy access token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="720" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Lấy thông tin user -->
        <mxCell id="fetch-user-info" value="Lấy thông tin user&#xa;từ Google (email, name, picture)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="810" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Kiểm tra whitelist -->
        <mxCell id="check-whitelist" value="Kiểm tra email&#xa;trong whitelist?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="339" y="900" width="150" height="100" as="geometry" />
        </mxCell>

        <!-- Email không trong whitelist -->
        <mxCell id="not-whitelisted" value="Trả về lỗi 403&#xa;&quot;Access denied&quot;&#xa;Email chưa được cấp quyền" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="564" y="920" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- Tạo JWT token -->
        <mxCell id="generate-jwt" value="Tạo JWT token&#xa;chứa user_id, email, name&#xa;(valid 24h)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="1030" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Lưu session -->
        <mxCell id="save-session" value="Lưu session cookie&#xa;(gorilla sessions)&#xa;với thông tin user" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="1130" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Set cookies -->
        <mxCell id="set-cookies" value="Set cookies:&#xa;- Session cookie&#xa;- auth_token (JWT)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="334" y="1230" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Redirect về frontend -->
        <mxCell id="redirect-frontend" value="Redirect về frontend&#xa;/auth/callback&#xa;với user data trong URL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="1330" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- Frontend lưu token -->
        <mxCell id="frontend-save" value="Frontend lưu token&#xa;và user info vào&#xa;localStorage/store" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="334" y="1430" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- End success -->
        <mxCell id="end-success" value="Đăng nhập&#xa;thành công" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="364" y="1530" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- End fail -->
        <mxCell id="end-fail" value="Đăng nhập&#xa;thất bại" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="584" y="1010" width="100" height="60" as="geometry" />
        </mxCell>

        <!-- Arrows -->
        <mxCell id="arrow1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="start" target="user-click-login">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="user-click-login" target="call-begin-auth">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="call-begin-auth" target="begin-auth-handler">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="begin-auth-handler" target="redirect-google">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="redirect-google" target="user-auth-google">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="user-auth-google" target="google-callback">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="google-callback" target="callback-handler">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="callback-handler" target="fetch-user-info">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="fetch-user-info" target="check-whitelist">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow10" value="Không" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="check-whitelist" target="not-whitelisted">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow11" value="Có" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="check-whitelist" target="generate-jwt">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="not-whitelisted" target="end-fail">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="generate-jwt" target="save-session">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="save-session" target="set-cookies">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="set-cookies" target="redirect-frontend">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="redirect-frontend" target="frontend-save">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arrow17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="frontend-save" target="end-success">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Chú thích -->
        <mxCell id="note1" value="Chú thích:&#xa;- Hộp xanh dương: Tác động từ người dùng/frontend&#xa;- Hộp vàng: Xử lý backend (API Server)&#xa;- Hình thoi đỏ: Điểm quyết định&#xa;- JWT token được dùng để xác thực với AI Server&#xa;- Session cookie được dùng để duy trì phiên đăng nhập" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="260" height="140" as="geometry" />
        </mxCell>

        <mxCell id="note2" value="Whitelist Database:&#xa;Email được hash SHA-256 trước khi so sánh&#xa;để bảo mật. Chỉ những email đã được&#xa;thêm vào whitelist mới có thể đăng nhập." style="text;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="900" width="260" height="100" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
